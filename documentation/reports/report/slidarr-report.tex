\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{siunitx}
\usepackage{caption}

\newcommand{\source}[1]{\hfill \vspace{-15pt} \caption*{ \footnotesize Source: {#1}} }

\title{\includegraphics[width=0.5\textwidth]{UU_logo.pdf}\\
Construction of the Slidarr}

\author{Mats Jonsson, SÃ¶ren Meinken, Mohammad El Musleh}
\date{May 2019}

\begin{document}

\maketitle

\pagebreak

\tableofcontents

\pagebreak

\section{Project Overview}

\subsection{From prestudy to project end}
The initial idea was to create an instrument that looks like a guitar and could even be used on a guitar but works in a completely different way. Touching or rather connecting two strings with the finger would connect them and from the location of the finger a tone would be created. This would essentially map the keys of a piano to the strings of the guitar. With that one can change the tone, pitch and also scroll to a different position on the note scale.

The goal for the project is to create a prototype that can demonstrate what kind of instrument this could turn out to be in the future and give the reader/spectator further stimulation for further ideas based on this concept. To be able to realize the project and get a prototype running optimized environment settings are used. This means there is only a single string/wire and a copper finger connected to a wire to measure the resistance/distance on the string where the two would touch. See figure x.

The focus for this proof of concept lies on the electronic hardware and software part so that the type of instrument created with it can vary and is in the hands of the artist.


\subsection{Concept}

The slidarr string represents a part of the traditional piano keyboard. Touching and releasing the Slidarr on the string has the same effect as pressing and releasing a piano key. The location is determined by the developed embedded system and sent to a synthesizer where the tone is generated. In addition to touching and releasing, it is also possible to slide on the point to the left or right, thus the name `Slidarr`. This has the effect of bending the pitch of the tone and jumping seamlessly to the next key/tone. 

The instrument needs to be calibrated before played to know the minimum and maxiumum resistance range of the wire. After that the calibrated range is mapped to one octave on the keyboard. After starting or resetting, the Slidarr usually starts in the middle of the keyboard which is a C4 with a frequency of 261 up to the next octave.

When sliding while touching the so called slide happens, which changes the frequency of the tone itself sending pitchbend messages to the synthesizer. After the pitch is on the maximum possible the software will turn the tone off and switch to the next tone.

To change the current octave to another location on the keyboard a scroll is possible. While touching the slidarr, holding down the scroll button and then sliding in a desired direction the `window` of the current range slides to the left or right of the total scale.

picture here of string compared to keyboard

\begin{figure}[ht]
  \centering
  \includegraphics[width=1\textwidth]{slidarr_2_.jpg}
  \caption{slidarr scetch}
  \label{fig:slidarr}
\end{figure}

Blabla blabla bla.

To sum it up these are the major functionalities of the Slidarr and important to know:
\begin{itemize}
 \item Touching, turn specifiv note on
 \item Sliding, changing the pitch and jumping to another tone
 \item Calibrating, setting the minimum and maximum range on the hardware for one octave
 \item Scrolling, moving the octave on the keyboard to higher or lower tones
\end{itemize}


\section{Analysis}

\subsection{Resistance measurement} \label{sec:resistance_measurement}
One way of determining the finger's position of the string is to measure the resistance from one end of the string to the finger. A copper wire of length 1 meter and diameter of \SI{0.5}{mm} has a resistance of \SI{0.5}{\ohm} per meter \cite{copperresistance}. In order to track the position  with millimeter accuracy, we need to measure in the sub-\si{\milli\ohm} range. 

This can be done in many different ways. One way is using a resistor bridge setup, e.g. a Wheatstone or Kelvin bridge, which is able to sense tiny changes in resistance. However, the bridge needs to be balanced with accurate resistors of similar value of the measured resistor, which is hard to achieve with standard resistors when the measured resistance is this small.

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.5\textwidth]{4-wire-sensing}
  \caption{4-terminal measurement}
  \source{allaboutcircuits.com}
  \label{fig:4terminal}
\end{figure}

An more suitable method is to use four-terminal measurement as shown in figure \ref{fig:4terminal}. A known constant currenti $I$ is fed through the resistor with unknown resistance $R$, and the voltage drop $V$ is measured with a separate pair of wires. The resistance can then easily be calculated using Ohms law, $ R = V / I $.

\subsection{Voltage measurement} \label{sec:voltage_measurement}
Using four-terminal measurement with a current of \SI{100}{\milli\ampere}, the change in voltage per millimeter string is \SI{50}{\micro\volt}. This has now turned into a matter of measuring low-level voltages.

A 12-bit ADC operating at \SIrange{0}{3.3}{\volt} has a resolution of \SI{0.8}{\milli\volt} per bit. The signal needs to be amplified by at least 16 times in order to achieve \si{\milli\meter} accuracy.

\subsubsection{Instrumentation amplifier}
Since we are interested in the voltage difference over the string, a differential amplifier is a good choice for amplifying the signal. The \textit{instrumentation amplifier} is widely used for amplifying low-level signals. It is stable and easy to adjust, since the amplification can be set by a single resistor \cite{in}.

\subsection{The MIDI protocol}
MIDI (Musical Instrument Digital Interface) protocol is the industry standard for communication between electronic musical instruments and synthesizers \cite{midiorg}. It does not transport the audio itself, instead messages with instructions about the note, its volume and duration are sent to a receiving device which generates the sound. 

MIDI was designed to be used with digital piano keyboards. The messages indicate \textit{note on}, \textit{note off}, and their \textit{velocity} (volume). The protocol is built around the concept of piano notes, which is not optimal for the Slidarr since it operates at a continous scale rather than at fixed frequency intervals.

The solution to this is the \textit{pitchbend} message, which is usually controlled by a wheel controller on the keyboard. It is a global parameter that bends the pitch (offsets the frequency) of the currently played notes, on synths that support it. The amount of bending is not standardized and can differ between synthesizers.

The MIDI message consists of three bytes: the \textit{command} and two \textit{parameters} \cite{midistanford}. There are many different commands, but the Slidarr only needs the three as shown in table \ref{table:midi_msgs}.

\begin{table}[h]
  \centering
  \caption{MIDI messages}
  \label{table:midi_msgs}
  \begin{tabular}{llll}
    Action     & Command & Parameter 1 & Parameter 2 \\ \hline
    Note off   & 0x80    & Key         & Velocity    \\
    Note on    & 0x90    & Key         & Velocity    \\
    Pitch bend & 0xE0    & Value       & Value      
  \end{tabular}
\end{table}

\subsection{Standard music notations and frequencies}
An \textit{octave} is a frequency interval where the higher note is twice the frequency of the lower note \cite{octave}. In western music, an octave is divided into 12 \textit{semitones}, named C through B, which correspond to a key on a piano. This is the pattern of keys that repeat over the keyboard as shown in \ref{fig:octave}. A piano usually stretches over seven octaves, numbered 1 through 7. A note needs to be identified by not only its name, but also its octave index, e.g. C4.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.5\textwidth]{octaves}
  \caption{Octaves on a piano}
  \source{https://music.stackexchange.com/questions/69410/what-is-an-octave}
  \label{fig:octave}
\end{figure}

Now when octaves, semitones and their relationships have been defined, the final tuning of the piano is left to be decided in order to be able to calculate the frequency of every key of a piano. Typically, the \textit{concert pitch} is used, which specifies that note A4 has a frequency of \SI{440}{\hertz}. All other keys on the piano can be derived from this key.

The MIDI standard specifies that C4 has index 60. Hence, note A4 has index 69. The frequency $f$ for any key $n$ can be calculated using the following formula:

$$ f = 440 \times 2^{\frac{n-69}{12}} $$

\subsection{Sound generation}
The MIDI signals does nothing on their own. They need to be interpreted by a \textit{sound synthesizer}, or \textit{synth} in short, which uses the MIDI input to control the frequency and characteristics of its audio output. They usually provide an interface for adjusting the parameters, making it possible to generate a wide variety of sounds using the same synth. 

There are countless of free software synths available online that supports MIDI and can be used with the Slidarr, but not every sound is suitable for this instrument. Since it is \textit{monophonic}, i.e. it can only play one note at a time, and is able to slide continously between notes, the synth should preferrably have a soft sound with a constant volume in order to hide the transition between notes when sliding.

\section{Design}

\subsection{Hardware}

The hardware can be divided into three parts: the \textit{string sensor}, i.e. the string and the conductor; the \textit{positioning unit}, and the microcontroller.

\subsubsection{Positioning unit}
The positioning unit contains the constant current regulator and the instrumentation amplifier, as described in section \ref{sec:resistance_measurement}. An LM317 voltage regulator is set up to feed a constant current through the string. The current $I$ is determined by resistor $R2$ \cite{lm317}:

$$ I = \frac{1.25}{R_2} $$

For $ I = \SI{100}{\milli\ampere} $, $R_2 = \SI{12.5}{\ohm} $. This resistor also dissipates some power, and a high power resistor is necessary. In the lack of these, 8 parallel \SI{100}{\ohm} \SI{0.25}{\watt} resistors was sufficient.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.9\textwidth]{slidarr-circuit}
  \caption{Positioning unit}
  \label{fig:slidarr-circuit}
\end{figure}

The instrumentation amplifier is built using three operation amplifiers. Its total amplification $A$ can be determined by:

$$ A = 1 + \frac{2R_3}{R_4} $$. 

As mentioned in section \ref{sec:voltage_measurement}, $ A \geq 16 $ for \si{\milli\meter} resolution. But even higher precision be achieved. The maximum voltage difference over the string is:

$$\SI{300}{\milli\meter} \cdot \SI{15}{\micro\volt}= \SI{15}{\milli\volt} $$. 
The resolution is maximized when the maximum amplification is \SI{3.3}{\volt}. The amplification then becomes:

$$ A = \SI{3.3}{\volt} / \SI{15}{\milli\volt} = 220 $$ 

By choosing $R_3 = \SI{10}{\kilo\ohm} $ and $R_4 = \SI{100}{\ohm} $, $ A = 201 $ which is more than sufficient.

Since the op-amps need to be powered with both positive and negative voltage, relative to the input voltage, the resistor $R_1$ is used to raise the string sensor's voltage to $V_{CC}/2$.

The TS464 is a chip with four integrated op-amps. Figure \ref{fig:slidarr-circuit2} shows how the final circuit is set up using this chip.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.9\textwidth]{slidarr-circuit2}
  \caption{The positioning unit using a TS464 quad-op-amp.}
  \label{fig:slidarr-circuit2}
\end{figure}

\subsubsection{String sensor}
The string sensor consists of a \SI{300}{\milli\meter} long copper wire with a diameter of \SI{0.5}{\milli\meter}, stretched between two screws on a wooden plank (see figure \ref{fig:string_sensor}.  The user wears a conductive copper C-shaped ring on one of its fingers, which will be used to make contact with the string. The C-shape makes it possible to bend the ring to a perfect fit for the user. The voltage difference can then be measured between the ring and one end of the string. The string sensor can be though of as a simple potentiometer, marked SLIDARR in figure \ref{fig:slidarr-circuit}.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.9\textwidth]{string-sensor}
  \caption{The string sensor}
  \label{fig:string_sensor}
\end{figure}

\subsubsection{Power supply}

\subsubsection{Microcontroller}

\section{Implementation}

\subsection{Calibration}

\subsection{Scrolling}

\subsection{Making MIDI continuous}

\subsection{The state machine}

image of simple state machine

\subsection{Streaming MIDI}

\subsection{Wireless bridge}

\section{Testing and verification}

\section{Results}

\subsection{Feasability}

\subsection{Future improvements and implementations}

picture with concepts


\begin{thebibliography}{9}

\bibitem{copperresistance} 
Chemandy Electronics: Round Wire Resistance Calculator,
\\\texttt{https://chemandy.com/calculators/round-wire-resistance-calculator.htm}

\bibitem{in} 
Electronics Hub: Instrumentation Amplifier Basics and Applications,
\\\texttt{https://www.electronicshub.org/instrumentation-amplifier-basics-applications}

\bibitem{midiorg} 
The MIDI Association,
\\\texttt{https://www.midi.org}

\bibitem{midistanford}
Stanford CCRMA: Essentials of the MIDI protocol,
\\\texttt{https://ccrma.stanford.edu/~craig/articles/linuxmidi/misc/essenmidi.html}

\bibitem{octave}
Encyclopedia Britannica: Octave,
\\texttt{https://www.britannica.com/art/octave-music}

\bibitem{sengpielaudio}
Sengpiel Audio: Keyboard ad frequencies,
\\texttt{http://www.sengpielaudio.com/calculator-notenames.htm}

\bibitem{lm317}
LEDnique: LM317 constant-current power supply,
\\texttt{http://lednique.com/power-supplies/lm317-constant-current-power-supply/}

\end{thebibliography}
\end{document}
